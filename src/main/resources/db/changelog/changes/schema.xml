<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xs="http://www.w3.org/2001/XMLSchema"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.4.xsd">

    <changeSet id="create_schema" author="SemyonKorostik">
        <createTable tableName="user_role">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="role_name" type="varchar(40)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="user">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_name" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="user_login" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="user_password" type="clob">
                <constraints nullable="false"/>
            </column>
            <column name="role_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="language" type="varchar(30)"/>
        </createTable>

        <createTable tableName="test">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="int"/>
            <column name="created_at" type="datetime"/>
            <column name="updated_at" type="datetime"/>
            <column name="started_at" type="datetime"/>
            <column name="finished_at" type="datetime"/>
            <column name="status" type="varchar(256)"/>
            <column name="evaluation" type="int" defaultValue="0"/>
        </createTable>

        <createTable tableName="level">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="level_name" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="module">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="module_name" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="question">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="question_body" type="clob"/>
            <column name="points" type="int"/>
            <column name="level_id" type="int">
            </column>
            <column name="module_id" type="int">
            </column>
            <column name="creator_user_id" type="int"/>
            <column name="is_avaliable" type="boolean" defaultValue="true"/>
        </createTable>

        <createTable tableName="test_question">
            <column name="test_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="question_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="answer">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="answer_body" type="clob"/>
            <column name="question_id" type="int"/>
            <column name="is_correct" type="boolean" defaultValue="false"/>
        </createTable>

        <createTable tableName="file_answer">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="url" type="clob">
                <constraints nullable="false"/>
            </column>
            <column name="question_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="content_file">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="question_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="url" type="clob">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="choosen_option">
            <column name="test_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="question_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="choosen_answer_id" type="int"/>
            <column name="file_answer_id" type="int"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="user" baseColumnNames="role_id"
                                 constraintName="user_user_role_fk"
                                 referencedTableName="user_role" referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="test" baseColumnNames="user_id" constraintName="test_user_fk"
                                 referencedTableName="user" referencedColumnNames="id"/>


        <addForeignKeyConstraint baseTableName="question" baseColumnNames="level_id"
                                 constraintName="question_level_fk"
                                 referencedTableName="level" referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="question" baseColumnNames="module_id"
                                 constraintName="question_module_fk"
                                 referencedTableName="module" referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="question" baseColumnNames="creator_user_id"
                                 constraintName="question_user_fk"
                                 referencedTableName="user" referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="test_question" baseColumnNames="test_id"
                                 constraintName="test_question_test_fk"
                                 referencedTableName="test" referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="test_question" baseColumnNames="question_id"
                                 constraintName="test_question_question_fk"
                                 referencedTableName="question" referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="answer" baseColumnNames="question_id"
                                 constraintName="answer_question_fk"
                                 referencedTableName="question" referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="content_file" baseColumnNames="question_id"
                                 constraintName="content_file_question_fk"
                                 referencedTableName="question" referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="choosen_option" baseColumnNames="test_id"
                                 constraintName="choosen_option_test_fk"
                                 referencedTableName="test" referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="choosen_option" baseColumnNames="question_id"
                                 constraintName="choosen_option_question_fk"
                                 referencedTableName="question" referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="choosen_option" baseColumnNames="choosen_answer_id"
                                 constraintName="choosen_option_answer_fk"
                                 referencedTableName="answer" referencedColumnNames="id"/>


    </changeSet>

    <changeSet id="update_status_type" author="Anlord241">
        <validCheckSum>8:429e8ab296a5ea20f0e1bb7bf7a5f389</validCheckSum>
        <sql>CREATE TYPE status AS ENUM ('NOT_STARTED', 'STARTED', 'FINISHED')</sql>
        <modifyDataType
                columnName="status"
                newDataType="status"
                schemaName="language_testing"
                tableName="test"/>
    </changeSet>

    <changeSet id="delete_column" author="Darina">
        <dropColumn tableName="question"
                    columnName="points"/>
    </changeSet>

    <changeSet id="update_column_name" author="Darina">
        <renameColumn tableName="question"
                      oldColumnName="is_avaliable"
                      newColumnName="is_available"
                      columnDataType="boolean"/>
    </changeSet>

    <changeSet id="add_table_coach_grades" author="Darina">
        <createTable tableName="coach_grade">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="grade" type="int" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="question_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="test_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="coach_grade"
                                 baseColumnNames="question_id"
                                 constraintName="question_id_fk"
                                 referencedTableName="question"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="coach_grade"
                                 baseColumnNames="test_id"
                                 constraintName="test_id_fk"
                                 referencedTableName="test"
                                 referencedColumnNames="id"/>

    </changeSet>

    <changeSet id="add_field_coach_to_test" author="Darina">
        <addColumn tableName="test">
            <column name="coach_id" type="int"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="test"
                                 baseColumnNames="coach_id"
                                 constraintName="coach_id_fk"
                                 referencedTableName="user"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="add_fk_for_file_answer" author="Darina">
        <addForeignKeyConstraint baseTableName="file_answer"
                                 baseColumnNames="question_id"
                                 constraintName="file_answer_question_id_fk"
                                 referencedTableName="question"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="add_fk_for_choosen_option" author="Darina">
        <addForeignKeyConstraint baseTableName="choosen_option"
                                 baseColumnNames="file_answer_id"
                                 constraintName="choosen_option_file_answer_fk"
                                 referencedTableName="file_answer"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="add_users" author="maxim12321">
        <insert tableName="user_role">
            <column name="id" valueSequenceNext="user_role_id_seq"/>
            <column name="role_name" value="ROLE_USER"/>
        </insert>
        <insert tableName="user">
            <column name="id" valueSequenceNext="user_id_seq"/>
            <column name="role_id" valueSequenceCurrent="user_role_id_seq"/>
            <column name="user_login" value="rus_user@northsixty.com"/>
            <column name="user_name" value="Russian User"/>
            <column name="user_password" value="$2a$08$GMxUHVbQLa8OAz3OPDWSueJCMhWlcpPnUMusgBXMkHMoJQ.SP.FYq"/>
            <column name="language" value="rus"/>
        </insert>
        <insert tableName="user">
            <column name="id" valueSequenceNext="user_id_seq"/>
            <column name="role_id" valueSequenceCurrent="user_role_id_seq"/>
            <column name="user_login" value="eng_user@northsixty.com"/>
            <column name="user_name" value="English User"/>
            <column name="user_password" value="$2a$08$a0aliBqS39BxT4yrca6hHOh2ci6e5k3A/98myrElGBM8jwwkf.l0q"/>
            <column name="language" value="eng"/>
        </insert>

        <insert tableName="user_role">
            <column name="id" valueSequenceNext="user_role_id_seq"/>
            <column name="role_name" value="ROLE_HR"/>
        </insert>
        <insert tableName="user">
            <column name="id" valueSequenceNext="user_id_seq"/>
            <column name="role_id" valueSequenceCurrent="user_role_id_seq"/>
            <column name="user_login" value="rus_hr@northsixty.com"/>
            <column name="user_name" value="Russian HR"/>
            <column name="user_password" value="$2a$08$gEE.rXie709tNz5VrcpkTOjCHk3A8ZcAjI7M5Y04ytoCq3fx/t2ze"/>
            <column name="language" value="rus"/>
        </insert>
        <insert tableName="user">
            <column name="id" valueSequenceNext="user_id_seq"/>
            <column name="role_id" valueSequenceCurrent="user_role_id_seq"/>
            <column name="user_login" value="eng_hr@northsixty.com"/>
            <column name="user_name" value="English HR"/>
            <column name="user_password" value="$2a$08$X5.33q5PiFEcfO2uheVd4ucBCTplC7JIylm2nMkmrjJYrE5fQeRDW"/>
            <column name="language" value="eng"/>
        </insert>

        <insert tableName="user_role">
            <column name="id" valueSequenceNext="user_role_id_seq"/>
            <column name="role_name" value="ROLE_COACH"/>
        </insert>
        <insert tableName="user">
            <column name="id" valueSequenceNext="user_id_seq"/>
            <column name="role_id" valueSequenceCurrent="user_role_id_seq"/>
            <column name="user_login" value="rus_coach@northsixty.com"/>
            <column name="user_name" value="Russian Coach"/>
            <column name="user_password" value="$2a$08$9Ct.DBw2OvPu9R9EOTzJnuIa3XfIhnDN6ZamvgYjuJhbi4gQTRpY2"/>
            <column name="language" value="rus"/>
        </insert>
        <insert tableName="user">
            <column name="id" valueSequenceNext="user_id_seq"/>
            <column name="role_id" valueSequenceCurrent="user_role_id_seq"/>
            <column name="user_login" value="eng_coach@northsixty.com"/>
            <column name="user_name" value="English Coach"/>
            <column name="user_password" value="$2a$08$PHQ4VV9rcvsMlSlmnQjVWu11.qvUJC0WIRE/coSisCAc6rO316.wq"/>
            <column name="language" value="eng"/>
        </insert>

        <insert tableName="user_role">
            <column name="id" valueSequenceNext="user_role_id_seq"/>
            <column name="role_name" value="ROLE_ADMIN"/>
        </insert>
        <insert tableName="user">
            <column name="id" valueSequenceNext="user_id_seq"/>
            <column name="role_id" valueSequenceCurrent="user_role_id_seq"/>
            <column name="user_login" value="rus_admin@northsixty.com"/>
            <column name="user_name" value="Russian Admin"/>
            <column name="user_password" value="$2a$08$sp14HY.XnK2w.qRE7fqMA.ja2aSL5sFGMSPSPdk/nHK.2Lj4GgK.q"/>
            <column name="language" value="rus"/>
        </insert>
        <insert tableName="user">
            <column name="id" valueSequenceNext="user_id_seq"/>
            <column name="role_id" valueSequenceCurrent="user_role_id_seq"/>
            <column name="user_login" value="eng_admin@northsixty.com"/>
            <column name="user_name" value="English Admin"/>
            <column name="user_password" value="$2a$08$PZwaUFgnbTJ9yihBjkDd0e5pWCZfbWohfB/823LjCRE.sUnP2KuJm"/>
            <column name="language" value="eng"/>
        </insert>

        <rollback>
            <delete tableName="user_role">
                <where>role_name in ("ROLE_USER", "ROLE_HR", "ROLE_COACH", "ROLE_ADMIN")</where>
            </delete>
            <delete tableName="user">
                <where>user_login in ("rus_user", "rus_hr", "rus_coach", "rus_admin")</where>
            </delete>
            <delete tableName="user">
                <where>user_login in ("eng_user", "eng_hr", "eng_coach", "eng_admin")</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="add_modules" author="Darina">
        <insert tableName="module">
            <column name="module_name">Grammar</column>
        </insert>
        <insert tableName="module">
            <column name="module_name">Listening</column>
        </insert>
        <insert tableName="module">
            <column name="module_name">Essay</column>
        </insert>
        <insert tableName="module">
            <column name="module_name">Speaking</column>
        </insert>
    </changeSet>

    <changeSet id="add_level" author="Darina">
        <insert tableName="level">
            <column name="level_name">A1</column>
        </insert>
        <insert tableName="level">
            <column name="level_name">A2</column>
        </insert>
        <insert tableName="level">
            <column name="level_name">B1</column>
        </insert>
        <insert tableName="level">
            <column name="level_name">B2</column>
        </insert>
        <insert tableName="level">
            <column name="level_name">C1</column>
        </insert>
        <insert tableName="level">
            <column name="level_name">C2</column>
        </insert>

    </changeSet>

    <changeSet id="add_level_test" author="Darina">
        <addColumn tableName="test">
            <column name="level_id" type="int"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="test"
                                 baseColumnNames="level_id"
                                 constraintName="test_level_id_fk"
                                 referencedTableName="level"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="delete_question_id_from_content_file" author="Darina">
        <dropColumn tableName="content_file" columnName="question_id"/>
    </changeSet>

    <changeSet id="create_table_question_content_file" author="Darina">
        <createTable tableName="question_content_file">
            <column name="question_id" type="int"/>
            <column name="content_file_id" type="int"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="question_content_file"
                                 baseColumnNames="question_id"
                                 constraintName="content_file_question_question_id_fk"
                                 referencedTableName="question"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="question_content_file"
                                 baseColumnNames="content_file_id"
                                 constraintName="content_file_question_content_id_fk"
                                 referencedTableName="content_file"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="add_error_report_table" author="Anlord241">
        <createTable tableName="error_report">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="report_body" type="clob">
            </column>
            <column name="question_id" type="int">
            </column>
            <column name="test_id" type="int">
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="error_report" baseColumnNames="question_id"
                                 constraintName="error_report_question_id_fk"
                                 referencedTableName="question" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="error_report" baseColumnNames="test_id"
                                 constraintName="error_report_test_id_fk"
                                 referencedTableName="test" referencedColumnNames="id"/>
    </changeSet>

</databaseChangeLog>
